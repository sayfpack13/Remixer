<Window x:Class="Remixer.WPF.Views.AIChatWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:Remixer.WPF.ViewModels"
        xmlns:local="clr-namespace:Remixer.WPF"
        Title="AI Remix Assistant" Height="600" Width="800"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize"
        MinWidth="600" MinHeight="400">
    <Window.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Themes/ModernTheme.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <local:MessageRoleToBackgroundConverter x:Key="MessageRoleToBackgroundConverter"/>
            <local:MessageRoleToAlignmentConverter x:Key="MessageRoleToAlignmentConverter"/>
            <local:MessageRoleToLabelConverter x:Key="MessageRoleToLabelConverter"/>
            <local:MessageRoleToVisibilityConverter x:Key="MessageRoleToVisibilityConverter"/>
            <local:MessageRoleToForegroundConverter x:Key="MessageRoleToForegroundConverter"/>
            <local:MessageRoleToTextForegroundConverter x:Key="MessageRoleToTextForegroundConverter"/>
            <local:MessageRoleToTimestampForegroundConverter x:Key="MessageRoleToTimestampForegroundConverter"/>
            <local:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
            <local:InvertedBooleanToVisibilityConverter x:Key="InvertedBooleanToVisibilityConverter"/>
            <local:InvertedBooleanConverter x:Key="InvertedBooleanConverter"/>
        </ResourceDictionary>
    </Window.Resources>
    <Window.Background>
        <StaticResource ResourceKey="BackgroundPrimary"/>
    </Window.Background>
    
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="{StaticResource BackgroundElevated}" 
                CornerRadius="10" Padding="20,16" Margin="0,0,0,16">
            <Border.Effect>
                <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.15" Color="Black"/>
            </Border.Effect>
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel>
                    <TextBlock Text="AI Remix Assistant" 
                               Style="{StaticResource Heading1}" 
                               Margin="0,0,0,6"
                               FontSize="22"
                               FontWeight="Bold"/>
                    <TextBlock Text="Chat with AI to customize your audio remix" 
                               Style="{StaticResource CaptionText}" 
                               Foreground="{StaticResource TextSecondary}"
                               FontSize="13"/>
                </StackPanel>
                <Button Grid.Column="1" Content="Clear Chat" Command="{Binding ClearChatCommand}"
                        Style="{StaticResource SecondaryButton}" 
                        Padding="16,8"
                        MinWidth="110"
                        Height="36"
                        FontSize="12"/>
            </Grid>
        </Border>

        <!-- Chat Messages -->
        <Border Grid.Row="1" Background="{StaticResource BackgroundSecondary}"
                CornerRadius="8" Padding="16">
            <ScrollViewer VerticalScrollBarVisibility="Auto" 
                          x:Name="MessagesScrollViewer"
                          HorizontalScrollBarVisibility="Disabled">
                <ItemsControl ItemsSource="{Binding Messages}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid Margin="0,0,0,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto" MinWidth="250" MaxWidth="600"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- User Message (Right Aligned) -->
                                <Border Grid.Column="1"
                                        Background="{Binding Role, Converter={StaticResource MessageRoleToBackgroundConverter}}"
                                        CornerRadius="12" 
                                        Padding="14,12"
                                        HorizontalAlignment="{Binding Role, Converter={StaticResource MessageRoleToAlignmentConverter}}"
                                        MaxWidth="600">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.15" Color="Black"/>
                                    </Border.Effect>
                                    <StackPanel>
                                        <TextBlock Text="{Binding Role, Converter={StaticResource MessageRoleToLabelConverter}}" 
                                                   Style="{StaticResource CaptionText}"
                                                   Foreground="{Binding Role, Converter={StaticResource MessageRoleToForegroundConverter}}"
                                                   Margin="0,0,0,6"
                                                   FontWeight="SemiBold"
                                                   FontSize="11"
                                                   Visibility="{Binding Role, Converter={StaticResource MessageRoleToVisibilityConverter}}"/>
                                        <TextBlock Text="{Binding Content}" 
                                                   Style="{StaticResource BodyText}"
                                                   TextWrapping="Wrap"
                                                   LineHeight="22"
                                                   FontSize="14"
                                                   Foreground="{Binding Role, Converter={StaticResource MessageRoleToTextForegroundConverter}}"/>
                                        <TextBlock Text="{Binding Timestamp, StringFormat='{}{0:HH:mm}'}" 
                                                   Style="{StaticResource CaptionText}"
                                                   Foreground="{Binding Role, Converter={StaticResource MessageRoleToTimestampForegroundConverter}}"
                                                   Margin="0,6,0,0"
                                                   HorizontalAlignment="Right"
                                                   FontSize="10"
                                                   Opacity="0.7"/>
                                    </StackPanel>
                                </Border>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Border>

        <!-- Typing Indicator -->
        <Border Grid.Row="2" Background="{StaticResource BackgroundElevated}" 
                CornerRadius="8" Padding="14,12" Margin="0,12,0,0"
                Visibility="{Binding IsSending, Converter={StaticResource BooleanToVisibilityConverter}}">
            <Border.Effect>
                <DropShadowEffect BlurRadius="4" ShadowDepth="1" Opacity="0.1" Color="Black"/>
            </Border.Effect>
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="â³" FontSize="18" Margin="0,0,10,0" VerticalAlignment="Center">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsSending}" Value="True">
                                    <DataTrigger.EnterActions>
                                        <BeginStoryboard>
                                            <Storyboard RepeatBehavior="Forever">
                                                <DoubleAnimation Storyboard.TargetProperty="(TextBlock.RenderTransform).(RotateTransform.Angle)"
                                                                 From="0" To="360" Duration="0:0:1"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </DataTrigger.EnterActions>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                    <TextBlock.RenderTransform>
                        <RotateTransform CenterX="9" CenterY="9"/>
                    </TextBlock.RenderTransform>
                </TextBlock>
                <TextBlock Text="AI is thinking..." 
                           Style="{StaticResource BodyText}" 
                           Foreground="{StaticResource TextSecondary}"
                           FontSize="13"
                           VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- Input Area -->
        <Grid Grid.Row="3" Margin="0,16,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Background="{StaticResource BackgroundElevated}"
                    BorderBrush="{StaticResource BorderColor}"
                    BorderThickness="1"
                    CornerRadius="8">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="4" ShadowDepth="1" Opacity="0.1" Color="Black"/>
                </Border.Effect>
                <TextBox Text="{Binding UserInput, UpdateSourceTrigger=PropertyChanged}"
                         FontSize="14" Padding="14,12"
                         Background="Transparent"
                         Foreground="{StaticResource TextPrimary}"
                         BorderThickness="0"
                         AcceptsReturn="True"
                         TextWrapping="Wrap"
                         VerticalContentAlignment="Top"
                         MinHeight="48"
                         MaxHeight="120"
                         VerticalScrollBarVisibility="Auto"
                         KeyDown="TextBox_KeyDown"/>
            </Border>
            <Button Grid.Column="1" Content="Send" Command="{Binding SendMessageCommand}"
                    Style="{StaticResource PrimaryButton}" 
                    Margin="12,0,0,0" 
                    Padding="24,0"
                    MinWidth="100"
                    Height="48"
                    FontSize="14"
                    FontWeight="SemiBold"
                    IsEnabled="{Binding IsSending, Converter={StaticResource InvertedBooleanConverter}}"/>
        </Grid>

        <!-- Status Message -->
        <TextBlock Grid.Row="4" Text="Please load an audio file to start chatting" 
                   Style="{StaticResource CaptionText}"
                   Foreground="{StaticResource TextTertiary}"
                   HorizontalAlignment="Center"
                   Margin="0,8,0,0"
                   Visibility="{Binding IsAudioLoaded, Converter={StaticResource InvertedBooleanToVisibilityConverter}}"/>
    </Grid>
</Window>

